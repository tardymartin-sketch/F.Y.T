# ============================================
# F.Y.T V3 â€” USER STORIES (V2)
# Format optimisÃ© pour interprÃ©tation IA
# Mis Ã  jour aprÃ¨s validation wireframes
# ============================================

metadata:
  version: "3.0.1"
  date: "2025-01-06"
  total_stories: 48
  changes_from_v1:
    - "ATH-002: FAB supprimÃ©, bottom bar 4 onglets Ã©gaux"
    - "ATH-008: DÃ©tail champs modifiables/non modifiables"
    - "ATH-012: Option son supprimÃ©e"
    - "ATH-NEW-001: Modal preview sÃ©ance complÃ¨te"
    - "ATH-NEW-002: Vue 'Choisir ma sÃ©ance' avec dropdowns"
    - "COA-001: Messages ajoutÃ© dans sidebar"
    - "COA-010: ProgramEditor complet avec filtres combinables"
    - "COA-013: Option son supprimÃ©e"
    - "COA-011: DÃ©placÃ© de TeamView vers Ã©cran dÃ©diÃ© (sidebar)"
  categories:
    - db_migration
    - athlete_home
    - athlete_history
    - athlete_coach
    - athlete_profile
    - athlete_badges
    - coach_sidebar
    - coach_dashboard
    - coach_programs
    - coach_import
    - coach_messages
    - coach_settings
    - shared

# ============================================
# DATABASE MIGRATION
# ============================================
db_migration:
  - id: DB-001
    title: CrÃ©er table conversations
    priority: critical
    model: opus
    description: |
      Table pour regrouper les threads de messages par exercice
    sql: |
      CREATE TABLE conversations (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        athlete_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
        coach_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
        session_id UUID REFERENCES session_logs(id) ON DELETE SET NULL,
        exercise_name TEXT,
        last_message_at TIMESTAMPTZ DEFAULT now(),
        created_at TIMESTAMPTZ DEFAULT now(),
        UNIQUE(athlete_id, coach_id, session_id, exercise_name)
      );
      CREATE INDEX idx_conversations_athlete ON conversations(athlete_id);
      CREATE INDEX idx_conversations_coach ON conversations(coach_id);

  - id: DB-002
    title: CrÃ©er table messages
    priority: critical
    model: opus
    description: |
      Messages individuels liÃ©s aux conversations
    sql: |
      CREATE TABLE messages (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
        sender_id UUID NOT NULL REFERENCES profiles(id),
        content TEXT NOT NULL,
        is_read BOOLEAN DEFAULT false,
        created_at TIMESTAMPTZ DEFAULT now()
      );
      CREATE INDEX idx_messages_conversation ON messages(conversation_id, created_at);
      CREATE INDEX idx_messages_unread ON messages(sender_id, is_read) WHERE is_read = false;

  - id: DB-003
    title: CrÃ©er table badges
    priority: critical
    model: opus
    description: |
      DÃ©finition des 25 badges avec conditions
    sql: |
      CREATE TABLE badges (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        code TEXT UNIQUE NOT NULL,
        name TEXT NOT NULL,
        description TEXT NOT NULL,
        category TEXT NOT NULL,
        icon_svg TEXT NOT NULL,
        condition_type TEXT NOT NULL,
        condition_value INT NOT NULL,
        order_index INT DEFAULT 0
      );

  - id: DB-004
    title: CrÃ©er table user_badges
    priority: critical
    model: opus
    description: |
      Badges dÃ©bloquÃ©s par utilisateur
    sql: |
      CREATE TABLE user_badges (
        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
        user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
        badge_id UUID NOT NULL REFERENCES badges(id) ON DELETE CASCADE,
        unlocked_at TIMESTAMPTZ DEFAULT now(),
        progress_value INT DEFAULT 0,
        UNIQUE(user_id, badge_id)
      );
      CREATE INDEX idx_user_badges_user ON user_badges(user_id);

  - id: DB-005
    title: Migrer donnÃ©es athlete_comments vers messages
    priority: high
    model: opus
    description: |
      Script de migration des commentaires existants vers le nouveau systÃ¨me
    acceptance_criteria:
      - CrÃ©er conversation pour chaque couple athlete/coach/session/exercise unique
      - Migrer chaque commentaire comme message
      - PrÃ©server is_read et created_at
      - Supprimer athlete_comments aprÃ¨s validation

  - id: DB-006
    title: RLS policies pour conversations et messages
    priority: critical
    model: opus
    description: |
      Politiques de sÃ©curitÃ© Row Level Security
    acceptance_criteria:
      - AthlÃ¨te voit ses conversations uniquement
      - Coach voit conversations de ses athlÃ¨tes
      - Sender peut crÃ©er messages dans ses conversations
      - Receiver peut marquer messages comme lus

# ============================================
# ATHLETE â€” ACCUEIL
# ============================================
athlete_home:
  - id: ATH-001
    title: KPI encouragement dynamique
    priority: high
    model: sonnet
    description: |
      Encart motivationnel basÃ© sur stats douces (pas de streak punitif)
    logic: |
      PRIORITÃ‰ AFFICHAGE (1er applicable):
      1. SÃ©ance aujourd'hui â†’ "Bravo pour cette sÃ©ance ! ðŸ’ª"
      2. X sÃ©ances cette semaine:
         - 1: "PremiÃ¨re sÃ©ance de la semaine, c'est parti !"
         - 2: "DeuxiÃ¨me entraÃ®nement de la semaine, bravo !"
         - 3+: "DÃ©jÃ  [X] sÃ©ances cette semaine, tu assures !"
      3. Proche palier mensuel (8-9 â†’ 10, 14-15 â†’ 15):
         "BientÃ´t [palier] entraÃ®nements ce mois-ci !"
      4. Proche record mensuel (record - 2):
         "Le record mensuel approche !"
      5. Record Ã©galÃ©: "Record mensuel Ã©galÃ© ! ðŸ†"
      6. Nouveau record: "Nouveau record mensuel ! ðŸŽ‰"
      7. Fallback: "PrÃªt pour ta prochaine sÃ©ance ?"
    component: EncouragementKPI
    location: Home.tsx

  - id: ATH-002
    title: Navigation mobile bottom bar (SANS FAB)
    priority: critical
    model: opus
    description: |
      Bottom navigation 4 onglets Ã©gaux, PAS de FAB
    tabs:
      - id: home
        icon: Home
        label: Accueil
        width: 25%
      - id: history
        icon: History
        label: Historique
        width: 25%
      - id: coach
        icon: MessageSquare
        label: Coach
        badge: unreadCount
        width: 25%
      - id: profile
        icon: User
        label: Profil
        width: 25%
    behavior:
      - Hauteur: 64px + env(safe-area-inset-bottom)
      - Highlight onglet actif
      - Badge non-lus sur Coach (pastille rouge)
      - PAS DE FAB - le dÃ©marrage sÃ©ance se fait via bouton dans Home
    styling:
      - "grid-template-columns: repeat(4, 1fr)"
      - Position fixed bottom
    component: BottomNavigation
    location: BottomNavigation.tsx (nouveau)

  - id: ATH-NEW-001
    title: Modal preview sÃ©ance complÃ¨te
    priority: medium
    model: sonnet
    description: |
      Modal affichant tous les exercices de la sÃ©ance sÃ©lectionnÃ©e
    trigger: Clic sur le SessionPreview (encart preview)
    content:
      - Header: Nom de la sÃ©ance + bouton fermer
      - Subtitle: Nombre exercices + durÃ©e estimÃ©e
      - Liste scrollable: Tous les exercices avec dÃ©tails
        - Nom exercice
        - SÃ©ries Ã— Reps
        - Repos
        - Tempo (si dÃ©fini)
        - Notes coach (si dÃ©finies)
      - Footer: Bouton "DÃ©marrer cette sÃ©ance"
    behavior:
      - Modal centrÃ©, max-height 85dvh
      - Scroll interne si contenu dÃ©passe
      - Fermeture: clic âœ•, clic overlay, touche Escape
      - Bouton dÃ©marrer â†’ lance la sÃ©ance (mÃªme logique que bouton principal)
    component: SessionPreviewModal
    location: Home.tsx ou composant dÃ©diÃ©

  - id: ATH-NEW-002
    title: Vue "Choisir ma sÃ©ance" avec filtres
    priority: medium
    model: sonnet
    description: |
      Vue alternative de l'accueil avec dropdowns de sÃ©lection manuelle
    trigger: Clic sur bouton "ðŸ“‚ Choisir ma sÃ©ance"
    content:
      - MÃªme header + KPI encouragement
      - Section filtres:
        - Dropdown AnnÃ©e
        - Dropdown Mois (filtrÃ© par annÃ©e)
        - Dropdown Semaine (filtrÃ© par mois)
        - Dropdown SÃ©ance (filtrÃ© par semaine)
      - SessionPreview mis Ã  jour selon filtres
      - Bouton "DÃ©marrer"
      - Bouton "â† Retour sÃ©ance suggÃ©rÃ©e"
    behavior:
      - Filtres en cascade (annÃ©e â†’ mois â†’ semaine â†’ sÃ©ance)
      - Preview se met Ã  jour automatiquement
      - Retour = revenir Ã  la vue avec chips suggÃ©rÃ©s
    state:
      - showAdvancedFilters: boolean (toggle entre les deux vues)
    component: Home.tsx (extension)
    location: Home.tsx

# ============================================
# ATHLETE â€” HISTORIQUE
# ============================================
athlete_history:
  - id: ATH-003
    title: Encart KPIs agrandissable
    priority: medium
    model: sonnet
    description: |
      Stats condensÃ©es en haut de l'historique, tap pour agrandir
    states:
      collapsed:
        content: "ðŸ“Š Ce mois: [X] sÃ©ances â€¢ [Y]h â€¢ RPE [Z]"
        height: auto (environ 48px)
      expanded:
        content: |
          - SÃ©ances: X (+diff vs mois prÃ©cÃ©dent)
          - Temps total: Yh (+diff)
          - RPE moyen: Z (tendance â–²â–¼â—)
          - Exercices uniques: N
          - Record: "X sÃ©ances en 1 semaine (SX)"
        height: auto
    animation: height transition 300ms ease-out
    component: HistoryKPICard
    location: History.tsx

# ============================================
# ATHLETE â€” ONGLET COACH
# ============================================
athlete_coach:
  - id: ATH-004
    title: Messages coach swipables
    priority: high
    model: sonnet
    description: |
      Carrousel horizontal des messages WeekOrganizer visibles
    behavior:
      - Swipe horizontal natif (CSS scroll-snap)
      - Indicateurs dots en dessous
      - Animation incitation au 1er affichage:
        - keyframes swipe-hint (translateX oscillant)
        - DurÃ©e 2s, jouÃ© une seule fois
        - Flag localStorage pour ne pas rejouer
    component: CoachMessagesCarousel
    location: CoachTab.tsx (nouveau)

  - id: ATH-005
    title: Liste conversations threads
    priority: high
    model: opus
    description: |
      Interface WhatsApp-like pour discussions avec coach
    features:
      - Liste conversations triÃ©es par last_message_at DESC
      - Badge compteur non-lus par conversation (pastille avec nombre)
      - Preview dernier message tronquÃ© (1 ligne max)
      - Indicateur lu/non-lu:
        - âœ“ = envoyÃ©
        - âœ“âœ“ = lu par destinataire
        - ðŸ”´ = non lu (messages reÃ§us)
      - Horodatage relatif (â€¢ 2h, â€¢ hier, â€¢ 3j)
    component: ConversationsList
    location: CoachTab.tsx

  - id: ATH-006
    title: Vue thread conversation
    priority: high
    model: opus
    description: |
      Ã‰cran de discussion individuelle style messagerie
    features:
      - Header: nom exercice + bouton retour â†
      - Contexte: "ðŸ“… SÃ©ance [nom] - [date]"
      - Bulles messages:
        - Droite (bleu) = messages de l'athlÃ¨te (moi)
        - Gauche (gris) = messages du coach
      - Horodatage sous chaque message
      - Statut sous messages envoyÃ©s (âœ“ ou âœ“âœ“)
      - Input message en bas + bouton envoyer âž¤
      - Auto-scroll au dernier message
      - Marquer comme lu Ã  l'ouverture (is_read = true)
    component: ConversationThread
    location: ConversationThread.tsx (nouveau)

  - id: ATH-007
    title: CrÃ©ation nouveau thread depuis session
    priority: medium
    model: sonnet
    description: |
      Bouton commentaire sur exercice dans ActiveSession crÃ©e/ouvre thread
    behavior:
      - Clic icÃ´ne commentaire ðŸ’¬ sur exercice dans ActiveSession
      - Recherche conversation existante (athlete_id, coach_id, session_id, exercise_name)
      - Si existe â†’ ouvrir ConversationThread
      - Sinon â†’ crÃ©er conversation + ouvrir ConversationThread
    integration: ActiveSession.tsx (modification existant)

# ============================================
# ATHLETE â€” PROFIL
# ============================================
athlete_profile:
  - id: ATH-008
    title: Section infos modifiables (PRÃ‰CISÃ‰)
    priority: medium
    model: sonnet
    description: |
      Formulaire Ã©dition avec distinction modifiable/non modifiable
    fields_editable:
      - firstName:
          type: text
          required: true
          label: "PrÃ©nom"
      - lastName:
          type: text
          required: true
          label: "Nom"
    fields_readonly:
      - username:
          label: "Nom d'utilisateur"
          display: grisÃ© + icÃ´ne ðŸ”’
          help: "Contacte le support pour changer"
      - email:
          label: "Email"
          display: grisÃ© + icÃ´ne ðŸ”’
          help: "LiÃ© Ã  ton compte Supabase Auth"
    fields_hidden:
      - role (gÃ©rÃ© par admin)
      - coachId (gÃ©rÃ© par admin)
    modal:
      trigger: Clic sur bouton âœï¸ dans la section profil
      content: Formulaire avec les 4 champs (2 Ã©ditables, 2 readonly)
      actions: Sauvegarder / Annuler (fermer)
    component: ProfileInfoSection + ProfileEditModal
    location: ProfileTab.tsx (nouveau)

  - id: ATH-009
    title: Grille badges avec progression
    priority: high
    model: opus
    description: |
      Affichage 25 badges en grille 5Ã—5, dÃ©bloquÃ©s/verrouillÃ©s
    display:
      - 5 lignes par catÃ©gorie (RÃ©gularitÃ©, Endurance, PersÃ©vÃ©rance, CommunautÃ©, Exploration)
      - Compteur par catÃ©gorie "â—â—â—â—‹â—‹ 3/5"
      - Badge dÃ©bloquÃ©: couleur + icÃ´ne visible
      - Badge verrouillÃ©: grisÃ© + icÃ´ne silhouette (opacity 0.3)
      - Compteur global "X/25 dÃ©bloquÃ©s"
    interaction:
      - Tap badge â†’ ouvre BadgeModal
      - Bouton "Voir tous les badges" â†’ scroll vers grille complÃ¨te
    component: BadgesGrid
    location: ProfileTab.tsx

  - id: ATH-010
    title: Modal dÃ©tail badge
    priority: medium
    model: sonnet
    description: |
      Popup affichant badge agrandi + condition + progression
    content_unlocked:
      - SVG badge 64Ã—64 (scale up du 16Ã—16)
      - Nom badge
      - Description condition
      - "âœ… DÃ©bloquÃ© le [date]"
      - Message fÃ©licitation
    content_locked:
      - SVG badge 64Ã—64 (grisÃ©)
      - Nom badge
      - Description condition
      - Barre progression "X/Y (Z%)"
      - Message encouragement "ðŸŽ¯ Plus que X !"
    component: BadgeModal
    location: ProfileTab.tsx

  - id: ATH-011
    title: Service calcul badges
    priority: critical
    model: opus
    description: |
      Logique backend/frontend pour calculer progression badges
    logic_streak: |
      SÃ‰RIE ACTIVE (tolÃ©rance 2 jours repos):
      - Compter jours avec â‰¥1 sÃ©ance
      - â‰¤2 jours repos consÃ©cutifs = sÃ©rie continue
      - >2 jours repos = sÃ©rie cassÃ©e
      
      ALGORITHME:
      1. RÃ©cupÃ©rer dates des sÃ©ances triÃ©es DESC
      2. Pour chaque jour, vÃ©rifier si sÃ©ance existe
      3. Compteur repos consÃ©cutifs
      4. Si repos > 2 â†’ sÃ©rie cassÃ©e, retourner compteur actuel
      5. Si sÃ©ance â†’ reset compteur repos, incrÃ©menter sÃ©rie
    condition_types:
      - streak_tolerant: jours actifs avec tolÃ©rance 2j (badges 1-5)
      - cumulative_hours: heures totales (badges 6-10)
      - count_rpe_gte: sÃ©ances avec RPE >= 7 (badges 11-13)
      - comeback: reprise aprÃ¨s 14j inactivitÃ© (badge 14)
      - consistency: 3 mois sans interruption >7j (badge 15)
      - message_count: messages envoyÃ©s (badges 16-20)
      - unique_exercises: exercices distincts (badges 21-22)
      - session_types: types sÃ©ances distincts (badge 23)
      - strava_connected: boolÃ©en (badge 24)
      - strava_imports: activitÃ©s importÃ©es (badge 25)
    component: badgeService.ts (nouveau)

# ============================================
# ATHLETE â€” PARAMÃˆTRES
# ============================================
athlete_settings:
  - id: ATH-012
    title: PrÃ©fÃ©rences entraÃ®nement athlÃ¨te (SANS SON)
    priority: low
    model: sonnet
    description: |
      Options personnalisation expÃ©rience (3 options, son supprimÃ©)
    options:
      - show_tempo:
          type: boolean
          default: true
          label: "Afficher le tempo"
      - show_coach_notes:
          type: boolean
          default: true
          label: "Notes du coach"
      - auto_rest_timer:
          type: boolean
          default: false
          label: "Timer repos automatique"
      # SUPPRIMÃ‰: rest_timer_sound
    storage: localStorage (clÃ©: 'fyt_athlete_preferences')
    component: AthleteSettings
    location: ProfileTab.tsx

# ============================================
# COACH â€” SIDEBAR
# ============================================
coach_sidebar:
  - id: COA-001
    title: Sidebar auto-hide avec hamburger (MESSAGES INCLUS)
    priority: high
    model: sonnet
    description: |
      Navigation desktop qui se cache automatiquement, Messages dans sidebar
    behavior:
      - Ã‰tat fermÃ© par dÃ©faut (width 0)
      - Bouton hamburger â˜° toujours visible (position fixed top-left)
      - Ouverture:
        - Hover zone gauche (0-50px) pendant 150ms
        - OU clic sur hamburger
      - Fermeture:
        - Souris quitte sidebar (dÃ©lai 300ms)
        - OU clic sur âœ•
        - OU clic sur item menu
        - OU clic hors sidebar (overlay)
    menu_items:
      - id: home
        icon: Home
        label: Accueil
      - id: import
        icon: Download
        label: Importer
      - id: team
        icon: Users
        label: Mes AthlÃ¨tes
      - id: messages
        icon: MessageSquare
        label: Messages
        badge: unreadCount  # NOUVEAU
      - id: settings
        icon: Settings
        label: ParamÃ¨tres
    footer:
      - Infos coach (nom, nombre athlÃ¨tes)
      - Bouton dÃ©connexion
    styling:
      - width: clamp(256px, 20vw, 320px)
      - Transition: transform 300ms ease-out
      - Overlay: opacity 300ms, background rgba(0,0,0,0.5)
    component: CoachSidebar
    location: CoachSidebar.tsx (nouveau, remplace Sidebar pour coach)

# ============================================
# COACH â€” DASHBOARD
# ============================================
coach_dashboard:
  - id: COA-002
    title: Cards KPIs dashboard
    priority: high
    model: sonnet
    description: |
      4 cartes mÃ©triques principales en grid responsive
    cards:
      - athletes_count:
          icon: Users
          value: count(profiles WHERE coach_id = currentUser.id)
          label: AthlÃ¨tes
      - unread_messages:
          icon: MessageSquare
          value: count(messages WHERE receiver = currentUser.id AND is_read = false)
          label: Non lus
      - avg_rpe:
          icon: Gauge
          value: avg(session_logs.session_rpe) WHERE date >= now() - 7 days
          label: RPE moyen (7j)
      - adherence_rate:
          icon: TrendingUp
          value: (sÃ©ances rÃ©alisÃ©es / sÃ©ances planifiÃ©es) * 100
          label: AdhÃ©sion
    styling:
      - "display: grid"
      - "grid-template-columns: repeat(4, 1fr)"
      - "gap: clamp(0.5rem, 2vw, 1rem)"
    component: DashboardKPIs
    location: CoachHome.tsx (nouveau)

  - id: COA-003
    title: RPE par groupe expandable
    priority: medium
    model: sonnet
    description: |
      Liste groupes avec RPE moyen, clic pour dÃ©tails athlÃ¨tes
    display_collapsed:
      - Pastille couleur groupe
      - Nom groupe
      - Barre progression RPE
      - Valeur RPE
      - Tendance (â–² +X / â–¼ -X / â— stable)
    display_expanded:
      - Tableau athlÃ¨tes du groupe:
        - Nom athlÃ¨te
        - DerniÃ¨re sÃ©ance (nom + date)
        - RPE derniÃ¨re sÃ©ance
        - Tendance individuelle
    behavior:
      - Clic sur ligne groupe â†’ toggle expand/collapse
      - Un seul groupe expanded Ã  la fois (accordion)
    component: GroupRPECard
    location: CoachHome.tsx

  - id: COA-004
    title: Bouton "Voir mes programmes"
    priority: medium
    model: sonnet
    description: |
      Navigation vers Ã©cran programmes
    behavior: setCurrentView('programs')
    styling: Card cliquable avec icÃ´ne â†’ Ã  droite
    location: CoachHome.tsx

# ============================================
# COACH â€” PROGRAMMES
# ============================================
coach_programs:
  - id: COA-005
    title: Ã‰cran liste programmes avec filtres combinables
    priority: high
    model: opus
    description: |
      Vue d'ensemble des programmes avec systÃ¨me de filtres type Excel
    filters:
      - year:
          type: select
          source: SELECT DISTINCT year FROM training_plans ORDER BY year DESC
          placeholder: "AnnÃ©e"
      - month:
          type: select
          source: SELECT DISTINCT Month, Month_num FROM training_plans WHERE year = :year
          placeholder: "Mois"
          depends_on: year
      - week:
          type: multi-select
          source: SELECT DISTINCT week FROM training_plans WHERE year = :year AND Month_num = :month
          placeholder: "Semaine(s)"
          depends_on: [year, month]
      - seance:
          type: multi-select
          source: SELECT DISTINCT seance_type FROM training_plans (filtrÃ© si autres filtres actifs)
          placeholder: "SÃ©ance(s)"
      - exercise:
          type: autocomplete
          source: SELECT DISTINCT exercise_name FROM training_plans
          placeholder: "ðŸ” Exercice..."
    filter_behavior:
      - Tous optionnels
      - Cumulatifs (AND)
      - Cascade: annÃ©e â†’ mois â†’ semaine
      - Affichage chips actifs: "[2025 âœ•] [Janvier âœ•] [S1-S4 âœ•]"
      - Bouton "RÃ©initialiser" efface tous les filtres
    display:
      - Graphique Ã©volution volume (Recharts LineChart)
      - Tableau dÃ©tail programmes
    data_query: |
      SELECT * FROM training_plans
      WHERE (:year IS NULL OR year = :year)
        AND (:month IS NULL OR Month_num = :month)
        AND (:weeks IS NULL OR week = ANY(:weeks))
        AND (:seances IS NULL OR seance_type = ANY(:seances))
        AND (:exercise IS NULL OR exercise_name ILIKE '%' || :exercise || '%')
      ORDER BY year, week, seance_type, order_index
    component: ProgramsView
    location: ProgramsView.tsx (nouveau)

  - id: COA-006
    title: Calcul KPIs programmes
    priority: medium
    model: sonnet
    description: |
      MÃ©triques affichÃ©es selon filtres
    metrics:
      - volume_total: SUM(target_sets::int * target_reps::int) par semaine
      - exercises_count: COUNT DISTINCT exercise_name
      - avg_rest: AVG(rest_time_sec)
    chart:
      - Type: LineChart (Recharts)
      - X-axis: Semaines
      - Y-axis: Volume
      - DonnÃ©es groupÃ©es par semaine
    component: programsService.ts (extension supabaseService)

  - id: COA-010
    title: ProgramEditor - Tableau Ã©dition inline complet
    priority: high
    model: opus
    description: |
      Ã‰diteur de programmes avec toutes les fonctionnalitÃ©s CRUD
    modes:
      - lecture: Affichage tableau readonly
      - edition: Cellules Ã©ditables inline
    toggle: Bouton [ðŸ‘ï¸ Lecture] / [âœï¸ Ã‰dition]
    columns:
      - semaine:
          type: select
          options: 1-52
          width: 8%
      - seance:
          type: select
          options: dynamic (seance_type existants + saisie libre)
          width: 12%
      - exercice:
          type: autocomplete
          source: exercise_name existants
          required: true
          width: 25%
      - series:
          type: number
          min: 1
          validation: entier > 0
          width: 10%
      - reps:
          type: text
          placeholder: "8-12, 30s, ..."
          width: 10%
      - repos:
          type: number
          unit: secondes
          min: 0
          width: 10%
      - actions:
          width: 15%
    actions_per_row:
      - reorder_up: "â†‘" (modifie order_index, swap avec ligne prÃ©cÃ©dente)
      - reorder_down: "â†“" (modifie order_index, swap avec ligne suivante)
      - validate: "âœ“" (sauvegarde modifications de cette ligne)
      - cancel: "âœ•" (annule modifications de cette ligne)
      - delete: "ðŸ—‘ï¸" (supprime avec confirmation)
    actions_global:
      - add_row:
          label: "+ Ajouter un exercice"
          behavior: InsÃ¨re ligne vide Ã  la fin, hÃ©rite sem/sÃ©ance de la derniÃ¨re ligne
      - delete_program:
          label: "ðŸ—‘ï¸ Supprimer tout ce programme"
          confirmation: Double confirmation (modal + saisie texte "SUPPRIMER")
      - cancel_all:
          label: "Annuler tout"
          behavior: Reset toutes les modifications non sauvÃ©es
      - save_all:
          label: "Sauvegarder tout (X modif)"
          behavior: Batch update vers Supabase
    validation:
      - SÃ©ries: entier > 0
      - Reps: non vide (texte libre pour flexibilitÃ©)
      - Repos: entier >= 0
      - Exercice: requis, non vide
    feedback:
      - Lignes modifiÃ©es: background jaune clair
      - Lignes en erreur: background rouge clair + message
      - Toast succÃ¨s aprÃ¨s sauvegarde: "X lignes modifiÃ©es"
      - Refresh donnÃ©es aprÃ¨s save
    component: ProgramEditor
    location: ProgramsView.tsx

# ============================================
# COACH â€” IMPORT
# ============================================
coach_import:
  - id: COA-007
    title: Wizard import CSV 3 Ã©tapes
    priority: high
    model: opus
    description: |
      Assistant guidÃ© pour import programmes
    steps:
      - step1_template:
          number: 1
          title: "TÃ©lÃ©charge un template"
          content:
            - Texte explicatif
            - 2 boutons tÃ©lÃ©chargement (cards cliquables)
          next: Bouton "Suivant â†’"
      - step2_fill:
          number: 2
          title: "Remplis-le"
          content:
            - Instructions textuelles concises
            - Liste des colonnes attendues
            - Tips de formatage
          next: Bouton "Suivant â†’"
          prev: Bouton "â† Retour"
      - step3_upload:
          number: 3
          title: "Importe-le"
          content:
            - Zone drag & drop
            - Preview aprÃ¨s upload
            - Validation + bouton import
          prev: Bouton "â† Retour"
    progress_indicator: Barre Ã©tapes avec numÃ©ros et Ã©tats (done/active/pending)
    component: ImportWizard
    location: ImportView.tsx (refactoring existant)

  - id: COA-008
    title: GÃ©nÃ©ration templates CSV
    priority: medium
    model: sonnet
    description: |
      2 fichiers CSV tÃ©lÃ©chargeables
    templates:
      - empty:
          filename: fyt_template_vide.csv
          content: Headers uniquement
          columns: year,week,seance_type,exercise_name,order_index,target_sets,target_reps,rest_time_sec,Tempo,Notes/Consignes
      - example:
          filename: fyt_template_exemple.csv
          content: Headers + 15-20 lignes variÃ©es
          sample_data:
            - year: 2025, week: 1, seance_type: Push, exercises: Bench Press, Incline DB, Cable Fly, OHP, Lateral Raises
            - year: 2025, week: 1, seance_type: Pull, exercises: Deadlift, Rowing, Pulldown, Face Pull, Curl
            - year: 2025, week: 1, seance_type: Legs, exercises: Squat, Leg Press, RDL, Leg Curl, Calf Raises
    generation: GÃ©nÃ©rÃ© cÃ´tÃ© client (Blob + download)
    component: ImportWizard

  - id: COA-009
    title: Preview et validation CSV
    priority: medium
    model: sonnet
    description: |
      Affichage aperÃ§u avant import final
    features:
      - Nom fichier uploadÃ© avec âœ…
      - Tableau preview 5 premiÃ¨res lignes
      - Compteur lignes valides "âœ… X lignes valides"
      - Compteur warnings "âš ï¸ X warnings: [dÃ©tails]"
      - Compteur erreurs "âŒ X erreurs: [dÃ©tails]"
      - Bouton "Importer X lignes" (disabled si erreurs critiques)
    validation_rules:
      - year: requis, entier
      - week: requis, entier 1-52
      - seance_type: requis, non vide
      - exercise_name: requis, non vide
      - target_sets: optionnel, entier si prÃ©sent
      - target_reps: optionnel
      - rest_time_sec: optionnel, entier si prÃ©sent (dÃ©faut: 60)
    component: CSVPreview
    location: ImportView.tsx

# ============================================
# COACH â€” MESSAGES (Ã‰CRAN DÃ‰DIÃ‰)
# ============================================
coach_messages:
  - id: COA-011
    title: Ã‰cran Messages coach (accessible depuis sidebar)
    priority: high
    model: opus
    description: |
      Liste toutes les conversations avec tous les athlÃ¨tes
      DÃ‰PLACÃ‰ de TeamView vers Ã©cran dÃ©diÃ© accessible via sidebar
    features:
      - Header: "Messages"
      - Barre recherche + filtre dropdown par athlÃ¨te
      - Compteur non-lus total
      - Liste conversations (mÃªme composant ConversationsList que athlÃ¨te)
      - Tri par last_message_at DESC
      - Au clic â†’ ouvre ConversationThread
    filter:
      - type: dropdown
      - options: "Tous" + liste athlÃ¨tes du coach
      - behavior: Filtre conversations par athlete_id
    component: CoachMessagesView
    location: CoachMessagesView.tsx (nouveau)

  - id: COA-012
    title: RÃ©ponse coach dans thread
    priority: high
    model: sonnet
    description: |
      Coach peut rÃ©pondre dans n'importe quel thread
    behavior:
      - MÃªme composant ConversationThread que athlÃ¨te
      - Identification sender_id = coach (currentUser.id)
      - Messages du coach affichÃ©s Ã  droite (style "moi")
      - Messages de l'athlÃ¨te affichÃ©s Ã  gauche
    location: ConversationThread.tsx (shared)

# ============================================
# COACH â€” PARAMÃˆTRES
# ============================================
coach_settings:
  - id: COA-013
    title: PrÃ©fÃ©rences entraÃ®nement coach (SANS SON)
    priority: low
    model: sonnet
    description: |
      Options personnalisation (3 options, son supprimÃ©)
    options:
      - show_tempo:
          type: boolean
          default: true
          label: "Afficher le tempo"
      - show_coach_notes:
          type: boolean
          default: true
          label: "Afficher les notes"
      - auto_rest_timer:
          type: boolean
          default: false
          label: "Timer repos automatique"
      # SUPPRIMÃ‰: rest_timer_sound
    storage: localStorage (clÃ©: 'fyt_coach_preferences')
    component: CoachSettings
    location: SettingsView.tsx (extension)

  - id: COA-014
    title: Connexion Strava coach
    priority: low
    model: sonnet
    description: |
      Permettre au coach de lier son Strava (optionnel)
    behavior: RÃ©utiliser composant StravaImport existant
    location: SettingsView.tsx

# ============================================
# SHARED COMPONENTS
# ============================================
shared:
  - id: SHR-001
    title: Service messages
    priority: critical
    model: opus
    description: |
      CRUD conversations et messages
    functions:
      - fetchConversations(userId, role):
          returns: Conversation[]
          query: |
            SELECT c.*, 
              (SELECT COUNT(*) FROM messages m 
               WHERE m.conversation_id = c.id 
               AND m.sender_id != :userId 
               AND m.is_read = false) as unread_count,
              (SELECT content FROM messages m 
               WHERE m.conversation_id = c.id 
               ORDER BY created_at DESC LIMIT 1) as last_message
            FROM conversations c
            WHERE c.athlete_id = :userId OR c.coach_id = :userId
            ORDER BY c.last_message_at DESC
      - fetchMessages(conversationId):
          returns: Message[]
          query: SELECT * FROM messages WHERE conversation_id = :id ORDER BY created_at ASC
      - sendMessage(conversationId, senderId, content):
          returns: Message
          actions:
            - INSERT INTO messages
            - UPDATE conversations SET last_message_at = now()
      - markAsRead(messageIds):
          returns: void
          query: UPDATE messages SET is_read = true WHERE id = ANY(:ids)
      - getUnreadCount(userId):
          returns: number
          query: |
            SELECT COUNT(*) FROM messages m
            JOIN conversations c ON m.conversation_id = c.id
            WHERE m.sender_id != :userId 
            AND m.is_read = false
            AND (c.athlete_id = :userId OR c.coach_id = :userId)
      - createConversation(athleteId, coachId, sessionId?, exerciseName?):
          returns: Conversation
          behavior: INSERT ou SELECT si existe dÃ©jÃ  (UPSERT via ON CONFLICT)
    location: messagesService.ts (nouveau)

  - id: SHR-002
    title: Types messages et badges
    priority: critical
    model: sonnet
    description: |
      Interfaces TypeScript
    types:
      - Conversation:
          id: string
          visibleId: string
          coachId: string
          sessionId?: string
          exerciseName?: string
          lastMessageAt: string
          createdAt: string
          unreadCount?: number
          lastMessage?: string
      - Message:
          id: string
          conversationId: string
          senderId: string
          content: string
          isRead: boolean
          createdAt: string
      - Badge:
          id: string
          code: string
          name: string
          description: string
          category: 'regularity' | 'endurance' | 'perseverance' | 'community' | 'exploration'
          iconSvg: string
          conditionType: string
          conditionValue: number
          orderIndex: number
      - UserBadge:
          id: string
          oderId: string
          visibleId: string
          unlockedAt?: string
          progressValue: number
      - ConversationRow (DB mapping)
      - MessageRow (DB mapping)
    location: types.ts (extension)

  - id: SHR-003
    title: Hook useUnreadCount
    priority: medium
    model: sonnet
    description: |
      Hook React pour compteur temps rÃ©el non-lus
    behavior:
      - Fetch initial au mount
      - Refresh Ã  chaque navigation vers messages
      - Expose: { count: number, refresh: () => void }
    usage:
      - BottomNavigation (badge sur Coach)
      - CoachSidebar (badge sur Messages)
    location: hooks/useUnreadCount.ts (nouveau)

  - id: SHR-004
    title: Composant DeviceDetector
    priority: medium
    model: sonnet
    description: |
      DÃ©tection device pour affichage conditionnel
    logic: |
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i
                       .test(navigator.userAgent);
      const hasTouch = window.matchMedia('(pointer: coarse)').matches;
      const hasMouse = window.matchMedia('(pointer: fine)').matches;
      
      return {
        isMobile: isMobile || (hasTouch && !hasMouse),
        isDesktop: !isMobile && hasMouse
      }
    usage:
      - App.tsx: Choisir entre BottomNavigation et CoachSidebar
    location: hooks/useDeviceDetect.ts (nouveau)
